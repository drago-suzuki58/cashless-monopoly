# Cashless Monopoly

[![React](https://img.shields.io/badge/React-19.2-blue.svg)](https://react.dev/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.9-blue.svg)](https://www.typescriptlang.org/)
[![Vite](https://img.shields.io/badge/Vite-7.3-purple.svg)](https://vitejs.dev/)
[![PWA](https://img.shields.io/badge/PWA-Ready-success.svg)](#)

*他の言語で読む: [English](README.md)*

アナログボードゲーム（モノポリー等）における「紙幣のやり取り」をデジタル化し、ゲームの進行を劇的に高速化するための、完全オフライン・サーバーレスのPWA（Progressive Web App）ツールです。

**注記:** *このプロジェクトはAIアシスタントの [OpenCode](https://github.com/github-copilot) によってゼロから生成・開発されました。*

## 🌟 概要と「オフラインファースト」アーキテクチャ

既存のボードゲーム用デジタル銀行アプリの最大の課題は、同じWi-Fiネットワークに接続する必要があったり、Bluetoothのペアリングを要求されたり、中央サーバーにアカウントを作る必要があったりすることです。

**Cashless Monopoly は、初期のページ読み込み以降、ネットワーク接続を一切必要としません。**

デバイス間の通信は全て「光学的（一方向）」に行われます。これは、高度に最適化されたJSONペイロードをQRコードに埋め込み、それを読み取るという手法で実現されています。

### 役割分担

*   🏦 **銀行 / Bank（親機・Source of Truth）**
    *   主にタブレットや、中央に置いた1台のスマホで動作させます。
    *   スキャナーとして機能し、プレイヤーが提示するQRコードを読み取ります。
    *   プレイヤーの残高、取引履歴、二重スキャン防止アルゴリズムなど、全ての「正となるデータ（正規状態）」を保持・管理します。
*   📱 **プレイヤー / Player（子機・リモコン）**
    *   各プレイヤーの個人のスマートフォンで動作させます。
    *   QRコードジェネレーターとして機能します。プレイヤーは手元のキーパッドで金額を入力し、「支払う」「貰う」「取り消す」「登録する」ためのQRペイロードを生成します。
    *   利便性のため、ローカル側でも計算を行い、独自の画面に現在の残高目安を表示します。

## 🚀 主要な機能とフェイルセーフ

*   **冪等性（二重スキャン防止）:**
    すべての取引QRには、プレイヤー固有の `uuid` と増分する連番（`seq`）が含まれています。もし銀行のカメラが誤って同じQRコードを2回連続で読み取ってしまったとしても、`uuid-seq` の組み合わせの重複を検知し、安全に無視します。
*   **堅牢なUndo（取消）システム:**
    金額を間違えてしまった場合、プレイヤーは自分のローカル履歴から過去の取引を選択し、「取消用QR」を生成できます。銀行がこれをスキャンすると、ターゲットの `seq` に基づいて、該当取引の金額を正確にロールバックします。
*   **クラッシュリカバリ（同期機能）:**
    誤ってブラウザのタブを閉じるなどしてプレイヤー側のデータが消えてしまった場合、銀行側から「復元用QR」を生成できます。
    *(最適化の注記: QRコードの密度が高くなりすぎて古いカメラで読み取れなくなるのを防ぐため、同期ペイロードには履歴配列を含めず、「現在の絶対残高」と「次に使うべきシーケンス番号」のみを転送します)*
*   **ダイナミックカメラ選択:**
    銀行の画面には、そのデバイスに搭載されている全カメラレンズのドロップダウンメニューが自動生成されます。これにより、QRコードのピントが合いやすい「マクロレンズ」や「特定の背面レンズ」に手動で素早く切り替えることができます。
*   **PWA完全対応:**
    ホーム画面に追加（インストール）することで、ブラウザの邪魔なUI（URLバー等）を隠し、シームレスなフルスクリーンネイティブアプリのような体験を提供します。

## 📦 データペイロードの仕様

即座に読み取れるように、QRコードのデータは極限まで小さく設計されています。標準的な取引ペイロードは以下のようになります。

```json
{
  "uuid": "player-id-string",
  "act": "tx",
  "amt": -150,
  "seq": 4
}
```
*   `act`: 取引の種類（`reg`=登録、`tx`=支払/受取、`undo`=取消、`sync`=同期）。
*   `amt`: 金額（マイナス = 銀行へ支払う、プラス = 銀行から貰う）。

## 🛠 技術スタック

*   **UIフレームワーク:** React 19, React Router v7
*   **スタイリング:** Tailwind CSS v4 (キーパッドが縦に間延びしないよう、モバイル向けに厳密な固定高で調整済)
*   **状態管理:** Zustand (localStorageへの永続化)
*   **QRスキャン:** `html5-qrcode`
*   **QR生成:** `qrcode.react`
*   **ビルドツール:** Vite (`vite-plugin-pwa` を使用)

## 💻 開発とセットアップ

Node.jsがインストールされていることを確認してください。

1.  **リポジトリのクローンと依存関係のインストール:**
    ```bash
    npm install
    ```
2.  **開発サーバーの起動:**
    ```bash
    npm run dev
    ```
    *(PCで銀行画面を開きつつ、Viteコンソールに表示されるローカルネットワークIPのURLをスマホで開くことで、プレイヤー画面のテストが可能です)*
3.  **本番用ビルド:**
    ```bash
    npm run build
    ```
