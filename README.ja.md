# Cashless Monopoly

[![React](https://img.shields.io/badge/React-19.2-blue.svg)](https://react.dev/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.9-blue.svg)](https://www.typescriptlang.org/)
[![Vite](https://img.shields.io/badge/Vite-7.3-purple.svg)](https://vitejs.dev/)
[![PWA](https://img.shields.io/badge/PWA-Ready-success.svg)](#)

*他の言語で読む: [English](README.md)*

アナログボードゲーム（モノポリー等）における「紙幣のやり取り」をデジタル化し、ゲームの進行を劇的に高速化するための、完全オフライン・サーバーレスのPWA（Progressive Web App）ツールです。

**注記:** *このプロジェクトはAIアシスタントの [OpenCode](https://opencode.ai) によってゼロから生成・開発されました。*

---

## 🎮 遊び方 / 使い方ガイド (How to Play)

アプリを開いてからゲームを遊ぶための基本的な流れです。

### 1. 準備（役割の決定）

ゲームを始める前に、端末の役割を決めます。

1. **銀行（親機）を用意する:** テーブルの真ん中に置けるタブレットやスマホを1台用意し、アプリのトップ画面から「銀行（親機）」を選択します。
2. **プレイヤー（子機）を用意する:** 遊ぶ人全員が、自分のスマホでアプリを開き「プレイヤー（子機）」を選択します。

### 2. 参加（プレイヤー登録）

1. 各プレイヤーは自分のスマホで**「名前」「テーマカラー」「初期残高（通常は1500など）」**を入力し、「登録用QRを表示する」ボタンを押します。
2. 画面にQRコードが表示されたら、中央に置かれた「銀行」端末のカメラにかざして読み取ってもらいます。
3. 銀行画面に自分の名前が追加されたら、プレイヤー端末の「読取完了」を押してゲーム画面に入ります。

### 3. ゲーム中の取引

すべてのお金のやり取りは、プレイヤーがQRコードを作り、銀行に読み取ってもらうことで完了します。

*   **銀行へ支払う / 銀行から貰う:**
    プレイヤー端末のキーパッドで金額を入力し、「支払う」または「貰う」をタップします。表示されたQRコードを銀行のカメラに読み取らせます。
*   **他のプレイヤーへの送金:**
    直接通信（P2P）はできないため、以下の2ステップで行います。
    1. 【払う側】が「〇〇 支払う」QRを作成し、銀行に読み取らせる。
    2. 【貰う側】が「〇〇 貰う」QRを作成し、銀行に読み取らせる。

### 4. 金額を間違えた時（取消 / Undo）

間違った金額をスキャンしてしまった場合は、やり直しが可能です。

1. 間違えたプレイヤーの端末で、右上の「履歴（時計マーク）」をタップします。
2. 取り消したい取引の「取消」ボタンを押し、取消用QRを表示します。
3. そのQRを銀行に読み取らせると、該当の取引がロールバックされ残高が元に戻ります。

### 5. データが消えてしまった時の復元（クラッシュリカバリ）

誤ってブラウザのタブを閉じたりリロードしたりすると、プレイヤー側のデータが初期化されることがあります。そのまま新規登録し直してしまうと、銀行側が記憶している「取引の順番（seq）」とズレてしまい、以降の取引がエラーになります。

**このような場合は、必ず以下の手順で「復元」を行ってください。**

1. 【銀行側】銀行の画面で、消えてしまったプレイヤーの名前パネルをタップします。
2. 【銀行側】「〇〇の復元用QR」が画面に表示されます。
3. 【プレイヤー側】プレイヤーの登録画面にある「銀行から復元」ボタンを押し、カメラを起動します。
4. 【プレイヤー側】銀行画面に表示されている復元用QRをスキャンすると、残高や取引の順番（seq）が完全に同期されてゲームに復帰できます。

---

## 🌟 概要と「オフラインファースト」アーキテクチャ

既存のボードゲーム用デジタル銀行アプリの最大の課題は、同じWi-Fiネットワークに接続する必要があったり、Bluetoothのペアリングを要求されたり、中央サーバーにアカウントを作る必要があったりすることです。

**Cashless Monopoly は、初期のページ読み込み以降、ネットワーク接続を一切必要としません。**

デバイス間の通信は全て「光学的（一方向）」に行われます。これは、高度に最適化されたJSONペイロードをQRコードに埋め込み、それを読み取るという手法で実現されています。

### 役割分担

*   🏦 **銀行 / Bank（親機・Source of Truth）**
    *   主にタブレットや、中央に置いた1台のスマホで動作させます。
    *   スキャナーとして機能し、プレイヤーが提示するQRコードを読み取ります。
    *   プレイヤーの残高、取引履歴、二重スキャン防止アルゴリズムなど、全ての「正となるデータ（正規状態）」を保持・管理します。
*   📱 **プレイヤー / Player（子機・リモコン）**
    *   各プレイヤーの個人のスマートフォンで動作させます。
    *   QRコードジェネレーターとして機能します。プレイヤーは手元のキーパッドで金額を入力し、「支払う」「貰う」「取り消す」「登録する」ためのQRペイロードを生成します。
    *   利便性のため、ローカル側でも計算を行い、独自の画面に現在の残高目安を表示します。

## 🚀 主要な機能とフェイルセーフ

*   **冪等性（二重スキャン防止）:**
    すべての取引QRには、プレイヤー固有の `uuid` と増分する連番（`seq`）が含まれています。もし銀行のカメラが誤って同じQRコードを2回連続で読み取ってしまったとしても、`uuid-seq` の組み合わせの重複を検知し、安全に無視します。
*   **堅牢なUndo（取消）システム:**
    金額を間違えてしまった場合、プレイヤーは自分のローカル履歴から過去の取引を選択し、「取消用QR」を生成できます。銀行がこれをスキャンすると、ターゲットの `seq` に基づいて、該当取引の金額を正確にロールバックします。
*   **クラッシュリカバリ（同期機能）:**
    誤ってブラウザのタブを閉じるなどしてプレイヤー側のデータが消えてしまった場合、銀行側から「復元用QR」を生成できます。
    *(最適化の注記: QRコードの密度が高くなりすぎて古いカメラで読み取れなくなるのを防ぐため、同期ペイロードには履歴配列を含めず、「現在の絶対残高」と「次に使うべきシーケンス番号」のみを転送します)*
*   **ダイナミックカメラ選択:**
    銀行の画面には、そのデバイスに搭載されている全カメラレンズのドロップダウンメニューが自動生成されます。これにより、QRコードのピントが合いやすい「マクロレンズ」や「特定の背面レンズ」に手動で素早く切り替えることができます。
*   **PWA完全対応:**
    ホーム画面に追加（インストール）することで、ブラウザの邪魔なUI（URLバー等）を隠し、シームレスなフルスクリーンネイティブアプリのような体験を提供します。

## 📦 データペイロードの仕様

即座に読み取れるように、QRコードのデータは極限まで小さく設計されています。標準的な取引ペイロードは以下のようになります。

```json
{
  "uuid": "player-id-string",
  "act": "tx",
  "amt": -150,
  "seq": 4
}
```
*   `act`: 取引の種類（`reg`=登録、`tx`=支払/受取、`undo`=取消、`sync`=同期）。
*   `amt`: 金額（マイナス = 銀行へ支払う、プラス = 銀行から貰う）。

## 🛠 技術スタック

*   **UIフレームワーク:** React 19, React Router v7
*   **スタイリング:** Tailwind CSS v4 (キーパッドが縦に間延びしないよう、モバイル向けに厳密な固定高で調整済)
*   **状態管理:** Zustand (localStorageへの永続化)
*   **QRスキャン:** `html5-qrcode`
*   **QR生成:** `qrcode.react`
*   **ビルドツール:** Vite (`vite-plugin-pwa` を使用)

## 💻 開発とセットアップ

Node.jsがインストールされていることを確認してください。

1.  **リポジトリのクローンと依存関係のインストール:**
    ```bash
    npm install
    ```
2.  **開発サーバーの起動:**
    ```bash
    npm run dev
    ```
    *(PCで銀行画面を開きつつ、Viteコンソールに表示されるローカルネットワークIPのURLをスマホで開くことで、プレイヤー画面のテストが可能です)*
3.  **本番用ビルド:**
    ```bash
    npm run build
    ```
